---
phase: 04-state-management
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/state/types.ts
  - src/state/initialState.ts
  - src/state/reducer.ts
  - src/state/reducer.test.ts
  - src/state/actions.ts
  - src/state/actions.test.ts
  - src/state/index.ts
autonomous: true

must_haves:
  truths:
    - "GameState type holds locations (Record<string, CardState[]>), currentPlayer, gamePhase, meta"
    - "CardState extends CardData with faceUp, selected, position fields"
    - "Pure reducer handles MOVE_CARD, FLIP_CARD, SELECT_CARD, SET_LOCATIONS, SET_GAME_PHASE, SET_CURRENT_PLAYER, DEAL_CARDS, SHUFFLE_LOCATION, RESET"
    - "Action creators produce correctly typed GameAction objects"
    - "No imports from @reduxjs/toolkit anywhere in src/state/"
  artifacts:
    - path: "src/state/types.ts"
      provides: "GameState, CardState, GameAction, all payload types"
      contains: "GameState"
    - path: "src/state/reducer.ts"
      provides: "Pure gameReducer function"
      exports: ["gameReducer"]
    - path: "src/state/actions.ts"
      provides: "Action creators including dealStandardDeck and shuffleLocation"
      exports: ["dealStandardDeck", "shuffleLocation"]
    - path: "src/state/initialState.ts"
      provides: "createInitialState factory"
      exports: ["createInitialState"]
    - path: "src/state/index.ts"
      provides: "Barrel exports for shared state module"
  key_links:
    - from: "src/state/reducer.ts"
      to: "src/state/types.ts"
      via: "import GameState, GameAction"
      pattern: "import.*GameState.*GameAction.*types"
    - from: "src/state/actions.ts"
      to: "src/types/card.ts"
      via: "import allCards for dealStandardDeck"
      pattern: "import.*allCards"
---

<objective>
Create the shared state foundation for Phase 4: types, pure reducer (TDD), action creators, and initial state factory.

Purpose: This is the core logic layer that both Context mode and Redux mode will share. By writing the reducer as a pure function with NO Redux Toolkit imports, it can be wrapped by createSlice for Redux or used directly with useReducer for Context mode.

Output: `src/state/` directory with types.ts, reducer.ts, actions.ts, initialState.ts, index.ts, and comprehensive tests.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-state-management/04-CONTEXT.md
@.planning/phases/04-state-management/04-RESEARCH.md
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: State types and initial state factory</name>
  <files>src/state/types.ts, src/state/initialState.ts</files>
  <action>
Create `src/state/types.ts` with NO imports from @reduxjs/toolkit:

1. Import `Suit` and `Rank` from `../types/card` (type-only import).

2. Define `CardState` interface extending CardData identity with UI state:
   - `suit: Suit` and `rank: Rank` (card identity)
   - `faceUp: boolean` (default false)
   - `selected: boolean` (default false)
   - `position?: { x: number; y: number }` (optional UI position)

3. Define `GameState` interface:
   - `locations: Record<string, CardState[]>` - dynamic location strings
   - `currentPlayer: string | null`
   - `gamePhase: string | null`
   - `meta: Record<string, unknown>` - arbitrary game metadata

4. Define all action payload interfaces:
   - `MoveCardPayload`: `{ cardIndex: number; from: string; to: string }`
   - `FlipCardPayload`: `{ location: string; cardIndex: number; faceUp: boolean }`
   - `SelectCardPayload`: `{ location: string; cardIndex: number; selected: boolean }`
   - `SetLocationsPayload`: `{ locations: Record<string, CardState[]> }`
   - `DealCardsPayload`: `{ from: string; to: Record<string, number>; faceUp?: boolean }`

5. Define `GameAction` discriminated union of all action types:
   - `MOVE_CARD`, `FLIP_CARD`, `SELECT_CARD`, `SET_LOCATIONS`
   - `SET_GAME_PHASE`, `SET_CURRENT_PLAYER`, `DEAL_CARDS`
   - `SHUFFLE_LOCATION`, `RESET`

Create `src/state/initialState.ts`:
- Export `createInitialState()` that returns a `GameState` with empty locations, null currentPlayer, null gamePhase, empty meta.
- Accept optional `Partial<GameState>` parameter for overrides.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors in state files.</verify>
  <done>GameState, CardState, GameAction types defined. createInitialState returns valid GameState. No RTK imports.</done>
</task>

<task type="auto">
  <name>Task 2: TDD pure reducer and action creators</name>
  <files>src/state/reducer.ts, src/state/reducer.test.ts, src/state/actions.ts, src/state/actions.test.ts, src/state/index.ts</files>
  <action>
**RED phase -- write failing tests first:**

Create `src/state/reducer.test.ts` with tests for each action type:

1. `MOVE_CARD` -- moves card from one location to another by index; returns unchanged state if card not found; auto-creates target location if missing.
2. `FLIP_CARD` -- toggles faceUp on card at location/index; no-op if card not found.
3. `SELECT_CARD` -- sets selected on card at location/index.
4. `SET_LOCATIONS` -- replaces locations with provided map (merge, not overwrite -- existing locations not in payload remain).
5. `SET_GAME_PHASE` -- sets gamePhase string.
6. `SET_CURRENT_PLAYER` -- sets currentPlayer string.
7. `DEAL_CARDS` -- deals N cards from source to each target location, setting faceUp; handles insufficient cards gracefully.
8. `SHUFFLE_LOCATION` -- shuffles cards at a location (test that length is preserved; exact order is random).
9. `RESET` -- returns initial state merged with optional partial override.
10. Unknown action type -- returns state unchanged.

Create `src/state/actions.test.ts` with tests:
1. `dealStandardDeck('deck')` produces SET_LOCATIONS action with 52 cards at 'deck' location, all faceUp=false, selected=false.
2. `shuffleLocation('deck')` produces SHUFFLE_LOCATION action with location payload.
3. `moveCard(0, 'deck', 'hand')` produces MOVE_CARD action.
4. `flipCard('hand', 0, true)` produces FLIP_CARD action.

**GREEN phase -- implement to pass:**

Create `src/state/reducer.ts`:
- Export `gameReducer(state: GameState, action: GameAction): GameState`
- Pure function with switch statement on `action.type`
- Use immutable spread patterns (NOT Immer -- this is the shared pure reducer)
- For SHUFFLE_LOCATION, use Fisher-Yates shuffle on a copy of the array
- For DEAL_CARDS, shift cards from source, push to targets with faceUp setting
- For RESET, return `{ ...createInitialState(), ...action.payload }`

Create `src/state/actions.ts`:
- Import `allCards` from `../types/card` for dealStandardDeck
- Export action creator functions that return typed `GameAction` objects:
  - `dealStandardDeck(locationId?: string)` -- creates SET_LOCATIONS with 52 CardState cards
  - `shuffleLocation(locationId: string)` -- creates SHUFFLE_LOCATION
  - `moveCard(cardIndex: number, from: string, to: string)` -- creates MOVE_CARD
  - `flipCard(location: string, cardIndex: number, faceUp: boolean)` -- creates FLIP_CARD
  - `selectCard(location: string, cardIndex: number, selected: boolean)` -- creates SELECT_CARD
  - `setGamePhase(phase: string)` -- creates SET_GAME_PHASE
  - `setCurrentPlayer(player: string)` -- creates SET_CURRENT_PLAYER
  - `reset(partial?: Partial<GameState>)` -- creates RESET

Create `src/state/index.ts` barrel:
- Re-export all types from types.ts
- Re-export gameReducer from reducer.ts
- Re-export createInitialState from initialState.ts
- Re-export all action creators from actions.ts
- Re-export any selectors (added in Plan 04-02)

Run tests: `npx vitest run src/state/`

**REFACTOR if needed** -- ensure clean code, no duplication.
  </action>
  <verify>`npx vitest run src/state/` -- all tests pass. Verify no `@reduxjs/toolkit` import: `grep -r "@reduxjs/toolkit" src/state/` returns nothing.</verify>
  <done>Pure reducer handles all 9 action types correctly. Action creators produce correctly typed GameAction. All tests pass. Zero RTK imports in src/state/.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/state/` -- all reducer and action tests pass
2. `npx tsc --noEmit` -- no type errors
3. `grep -r "@reduxjs/toolkit" src/state/` -- returns nothing (no RTK leakage)
4. GameState uses nested-by-location structure per CONTEXT.md decision
5. CardState includes suit, rank, faceUp, selected, position per decision
</verification>

<success_criteria>
- All 9 reducer action types tested and passing
- Action creators produce correctly typed GameAction objects
- createInitialState returns valid empty GameState
- Zero @reduxjs/toolkit imports in src/state/ directory
- Types support dynamic location strings (any string key)
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-01-SUMMARY.md`
</output>
