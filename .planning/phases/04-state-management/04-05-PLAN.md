---
phase: 04-state-management
plan: 05
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - vite.config.ts
  - package.json
  - src/index.ts
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Main entry point exports context mode provider, hooks, state types, actions, and selectors"
    - "Separate ./redux entry point exports Redux-specific code"
    - "Main entry has zero @reduxjs/toolkit imports"
    - "Vite builds both entry points successfully"
    - "All tests pass including state, context, redux, and hooks"
    - "TypeScript compilation succeeds with no errors"
  artifacts:
    - path: "src/index.ts"
      provides: "Main entry with context mode + hooks + state exports"
      contains: "GameProvider"
    - path: "vite.config.ts"
      provides: "Multi-entry Vite build configuration"
      contains: "card-components-redux"
    - path: "package.json"
      provides: "Exports field with ./redux subpath"
      contains: "./redux"
  key_links:
    - from: "vite.config.ts"
      to: "src/index.ts"
      via: "Main entry point in build.lib.entry"
      pattern: "src/index\\.ts"
    - from: "vite.config.ts"
      to: "src/redux/index.ts"
      via: "Redux entry point in build.lib.entry"
      pattern: "src/redux/index\\.ts"
    - from: "package.json"
      to: "dist/"
      via: "exports field mapping ./redux to dist output"
      pattern: "card-components-redux"
---

<objective>
Configure multi-entry build, update barrel exports, and verify complete Phase 4 integration.

Purpose: This plan wires everything together -- the main entry exports context mode + hooks for all users, the ./redux entry provides Redux-specific code for Redux users, and the build produces correct bundles for both. Final verification ensures all Phase 4 success criteria are met.

Output: Updated vite.config.ts, package.json, src/index.ts. Clean build and full test pass.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-state-management/04-CONTEXT.md
@.planning/phases/04-state-management/04-01-SUMMARY.md
@.planning/phases/04-state-management/04-02-SUMMARY.md
@.planning/phases/04-state-management/04-03-SUMMARY.md
@.planning/phases/04-state-management/04-04-SUMMARY.md
@src/index.ts
@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update main entry barrel exports</name>
  <files>src/index.ts</files>
  <action>
Add Phase 4 exports to `src/index.ts` (append to existing exports, do NOT remove any existing exports):

**State types and utilities (from src/state/):**
```typescript
// State management (Phase 4)
export { gameReducer } from './state';
export { createInitialState } from './state';
export {
  dealStandardDeck,
  shuffleLocation,
  moveCard as moveCardAction,
  flipCard as flipCardAction,
  selectCard as selectCardAction,
  setGamePhase,
  setCurrentPlayer,
  reset as resetAction,
} from './state';
export {
  selectAllLocations,
  selectLocation as selectLocationState,
  selectCard as selectCardState,
  selectGamePhase as selectGamePhaseState,
  selectCurrentPlayer as selectCurrentPlayerState,
  selectLocationCount,
} from './state';
export type {
  GameState,
  CardState,
  GameAction,
  MoveCardPayload,
  FlipCardPayload,
  SelectCardPayload,
  SetLocationsPayload,
  DealCardsPayload,
} from './state';
```

Note: Some action creator names conflict with existing exports (e.g., selectCard hook vs selectCard action). Use aliased exports to avoid collisions. The naming convention: action creators get `Action` suffix when conflicting, selectors get `State` suffix when conflicting, hooks keep their natural names.

**Context mode provider (from src/context/):**
```typescript
export { GameProvider } from './context';
export type { GameProviderProps } from './context';
export { loadState, saveState, clearState } from './context';
```

**Unified hooks (from src/hooks/ -- new Phase 4 hooks):**
```typescript
export { useGameState, useLocation, useCard, useGameActions } from './hooks';
export { useStateBackend, StateBackendContext } from './hooks';
export type { StateBackend } from './hooks';
```

Ensure NO imports from `@reduxjs/toolkit` appear in src/index.ts. The Redux entry point is separate.
  </action>
  <verify>`npx tsc --noEmit` -- no type errors. `grep "@reduxjs/toolkit" src/index.ts` returns nothing.</verify>
  <done>Main entry exports all Phase 4 context mode code, hooks, state types, actions, and selectors without RTK imports.</done>
</task>

<task type="auto">
  <name>Task 2: Multi-entry Vite build and package.json exports</name>
  <files>vite.config.ts, package.json, tsconfig.json</files>
  <action>
**Update `vite.config.ts`:**

Change `build.lib.entry` from single entry to object for multi-entry:
```typescript
build: {
  lib: {
    entry: {
      'card-components': resolve(__dirname, 'src/index.ts'),
      'card-components-redux': resolve(__dirname, 'src/redux/index.ts'),
    },
    formats: ['es', 'cjs'],
  },
  rollupOptions: {
    external: [
      'react', 'react-dom', 'react/jsx-runtime',
      'motion', 'motion/react',
      '@dnd-kit/core', '@dnd-kit/utilities', '@dnd-kit/modifiers',
      '@reduxjs/toolkit', 'react-redux',  // Externalize Redux deps
    ],
    output: {
      globals: {
        react: 'React',
        'react-dom': 'ReactDOM',
        'react/jsx-runtime': 'jsxRuntime',
        motion: 'motion',
        'motion/react': 'motionReact',
        '@reduxjs/toolkit': 'RTK',
        'react-redux': 'ReactRedux',
      },
    },
  },
  cssModules: true,
},
```

Remove the `name: 'CardComponents'` field from build.lib (not used with multi-entry object).

Remove the `fileName` field from build.lib (Vite auto-generates from entry keys).

Update `dts()` plugin to include both entry source trees:
```typescript
dts({
  include: ['src/**/*'],
  exclude: ['src/**/*.test.ts', 'src/**/*.test.tsx'],
}),
```
(This should already cover both entries since they're in src/.)

**Update `package.json`:**

Update the exports field to include the ./redux subpath:
```json
"exports": {
  ".": {
    "types": "./dist/card-components.d.ts",
    "import": "./dist/card-components.js",
    "require": "./dist/card-components.cjs"
  },
  "./redux": {
    "types": "./dist/card-components-redux.d.ts",
    "import": "./dist/card-components-redux.js",
    "require": "./dist/card-components-redux.cjs"
  }
}
```

Ensure `peerDependencies` includes (from 04-04):
```json
"@reduxjs/toolkit": "^2.0.0",
"react-redux": "^9.0.0"
```

Ensure `peerDependenciesMeta` (from 04-04):
```json
"peerDependenciesMeta": {
  "@reduxjs/toolkit": { "optional": true },
  "react-redux": { "optional": true }
}
```

Update `main` and `module` fields for the multi-entry format:
```json
"main": "./dist/card-components.cjs",
"module": "./dist/card-components.js",
"types": "./dist/card-components.d.ts"
```

**Check tsconfig.json:**
Ensure `src/state/` and `src/context/` and `src/redux/` are included in compilation. They should be by default since most configs include `src/**/*`.

**Run full verification:**
1. `npx vitest run` -- ALL tests pass (state, context, redux, hooks, components)
2. `npx tsc --noEmit` -- no type errors
3. `npm run build` -- Vite produces both entry bundles
4. Verify build output: `ls dist/` should contain card-components.js, card-components.cjs, card-components-redux.js, card-components-redux.cjs and corresponding .d.ts files
5. Verify no RTK in main bundle: `grep -l "reduxjs/toolkit" dist/card-components.js` should return nothing
  </action>
  <verify>
`npm run build` -- builds successfully with both entries.
`npx vitest run` -- all tests pass.
`ls dist/card-components-redux.*` -- Redux entry built.
`grep "@reduxjs/toolkit" dist/card-components.js` -- no RTK in main bundle (returns nothing).
  </verify>
  <done>Multi-entry build produces separate main and Redux bundles. Package.json exports both entry points. All tests pass. Main bundle is Redux-free.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- ALL project tests pass (Phases 1-4)
2. `npx tsc --noEmit` -- zero type errors
3. `npm run build` -- produces both entry point bundles
4. `ls dist/` contains card-components.{js,cjs} and card-components-redux.{js,cjs}
5. `grep "@reduxjs/toolkit" dist/card-components.js` -- returns nothing (main bundle is RTK-free)
6. Main entry exports: GameProvider, hooks, state types, actions, selectors
7. Redux entry exports: gameSlice, configureGameStore, ReduxGameProvider, Redux selectors
</verification>

<success_criteria>
- Vite multi-entry build produces both bundles
- Main bundle has zero @reduxjs/toolkit references
- Package.json exports field maps . and ./redux correctly
- All Phase 1-4 tests pass
- TypeScript compilation succeeds
- Library works without Redux (context mode via main entry)
- Redux users import from ./redux entry for Redux-specific code
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-05-SUMMARY.md`
</output>
