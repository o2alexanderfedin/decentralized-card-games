---
phase: 04-state-management
plan: 06
type: execute
wave: 5
depends_on: ["04-02", "04-03", "04-04", "04-05"]
files_modified:
  - src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx
  - src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts
  - src/components/StatefulCardDndProvider/StatefulCardDndProvider.test.tsx
  - src/components/StatefulCardDndProvider/index.ts
  - src/components/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Dragging a card from one zone to another automatically dispatches MOVE_CARD to state"
    - "StatefulCardDndProvider wraps CardDndProvider and wires onDragEnd to dispatch"
    - "Works with both GameProvider (context mode) and ReduxGameProvider (Redux mode)"
    - "Developer can still provide custom onDragEnd that runs alongside state dispatch"
    - "DnD events fire state actions without requiring manual wiring by the developer"
  artifacts:
    - path: "src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx"
      provides: "CardDndProvider wrapper that auto-dispatches state actions on DnD events"
      exports: ["StatefulCardDndProvider"]
    - path: "src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts"
      provides: "Props type extending CardDndProviderProps"
      exports: ["StatefulCardDndProviderProps"]
    - path: "src/components/StatefulCardDndProvider/index.ts"
      provides: "Barrel exports"
  key_links:
    - from: "src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx"
      to: "src/components/CardDndProvider/CardDndProvider.tsx"
      via: "Wraps CardDndProvider, passes through all props"
      pattern: "CardDndProvider"
    - from: "src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx"
      to: "src/hooks/useGameActions.ts"
      via: "Uses useGameActions to get dispatch for state updates"
      pattern: "useGameActions"
    - from: "src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx"
      to: "src/hooks/useLocation.ts"
      via: "Uses useLocation to find card index by identity for MOVE_CARD"
      pattern: "useLocation"
---

<objective>
Create StatefulCardDndProvider that bridges Phase 3 drag-and-drop with Phase 4 state management.

Purpose: The user decision states "Drag/drop lifecycle triggers Redux actions to update state" and "dragging a card automatically updates Redux state." This plan creates a wrapper around CardDndProvider that intercepts DnD lifecycle events and dispatches state actions (MOVE_CARD, etc.) automatically. Developers wrap their game in StatefulCardDndProvider instead of CardDndProvider to get automatic state synchronization.

Output: `src/components/StatefulCardDndProvider/` with component, types, tests, and barrel exports. Updated main barrel exports.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-state-management/04-CONTEXT.md
@.planning/phases/04-state-management/04-02-SUMMARY.md
@.planning/phases/04-state-management/04-03-SUMMARY.md
@src/components/CardDndProvider/CardDndProvider.tsx
@src/components/CardDndProvider/CardDndProvider.types.ts
@src/hooks/useGameActions.ts
@src/hooks/useLocation.ts
@src/state/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: StatefulCardDndProvider component and types</name>
  <files>src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx, src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts, src/components/StatefulCardDndProvider/index.ts</files>
  <action>
Create `src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts`:

1. Import `CardDndProviderProps` from `../CardDndProvider`.
2. Define `StatefulCardDndProviderProps` extending `CardDndProviderProps` with:
   - `autoDispatch?: boolean` -- enable auto-dispatch of MOVE_CARD on drag end (default: true)
   - All CardDndProviderProps are inherited so developers can still pass custom callbacks

Create `src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx`:

1. Import `CardDndProvider` from `../CardDndProvider`.
2. Import `useGameActions` from `../../hooks/useGameActions`.
3. Import `useLocation` from `../../hooks/useLocation` (not needed initially -- card index comes from DnD data).
4. Import `CardData` from `../../types`.

Implementation:
- Renders `<CardDndProvider {...props} onDragEnd={handleDragEnd} onDragStart={handleDragStart}>`.
- `handleDragEnd(card: CardData, targetZoneId: string | null, sourceZoneId?: string)`:
  - If `autoDispatch` is false OR `targetZoneId` is null OR `sourceZoneId` is undefined, skip auto-dispatch.
  - If `targetZoneId === sourceZoneId`, skip (no-op move).
  - Get dispatch from `useGameActions()`.
  - To find the cardIndex in the source location, the DnD data from Phase 3 DraggableCard should carry the index. Use a convention: the card's index in the source zone. Since CardDndProvider's onDragEnd provides `card: CardData` and `sourceZoneId`, the component needs to look up which index that card occupies in the source location's state. Use `useGameState()` to get state, then find the card by suit+rank match in `state.locations[sourceZoneId]`.
  - Dispatch: `dispatch('MOVE_CARD', { cardIndex: foundIndex, from: sourceZoneId, to: targetZoneId })`.
  - After auto-dispatch, also call the user's `onDragEnd` if provided (so developers can layer additional logic).
- `handleDragStart(card: CardData, sourceZoneId?: string)`:
  - Call user's `onDragStart` if provided. No auto-dispatch needed for start.

Create `src/components/StatefulCardDndProvider/index.ts`:
- Export StatefulCardDndProvider from './StatefulCardDndProvider'
- Export type StatefulCardDndProviderProps from './StatefulCardDndProvider.types'
  </action>
  <verify>`npx tsc --noEmit` -- no type errors.</verify>
  <done>StatefulCardDndProvider wraps CardDndProvider and auto-dispatches MOVE_CARD on successful drag-end.</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests and barrel export updates</name>
  <files>src/components/StatefulCardDndProvider/StatefulCardDndProvider.test.tsx, src/components/index.ts, src/index.ts</files>
  <action>
Create `src/components/StatefulCardDndProvider/StatefulCardDndProvider.test.tsx`:

Tests use GameProvider (context mode) wrapping StatefulCardDndProvider to verify end-to-end behavior:

1. **Auto-dispatches MOVE_CARD on drag end:** Set up initial state with cards in 'deck' location. Simulate a drag end event (card from 'deck' to 'hand'). Verify useLocation('hand') now contains the moved card and useLocation('deck') no longer contains it.
   - Use @testing-library/react renderHook or render + act pattern.
   - Since simulating full DnD is complex, test the internal dispatch logic: render StatefulCardDndProvider inside GameProvider, access the onDragEnd callback it passes to CardDndProvider, and call it directly with (card, 'hand', 'deck').

2. **Skips dispatch when targetZoneId is null:** Call onDragEnd with null targetZoneId. Verify state unchanged.

3. **Skips dispatch when sourceZoneId equals targetZoneId:** Call onDragEnd with same source and target. Verify state unchanged.

4. **autoDispatch=false disables auto-dispatch:** Pass autoDispatch={false}. Call onDragEnd. Verify state unchanged but user's onDragEnd callback still called.

5. **User onDragEnd still fires alongside auto-dispatch:** Pass a custom onDragEnd spy. Verify both auto-dispatch and spy are called.

6. **Works with ReduxGameProvider:** Repeat test 1 but wrap in ReduxGameProvider instead of GameProvider. Verify same behavior.

Update `src/components/index.ts`:
- Add export for StatefulCardDndProvider: `export { StatefulCardDndProvider } from './StatefulCardDndProvider';`
- Add type export: `export type { StatefulCardDndProviderProps } from './StatefulCardDndProvider';`

Update `src/index.ts`:
- Add to Phase 4 exports section: `export { StatefulCardDndProvider } from './components/StatefulCardDndProvider';`
- Add type export: `export type { StatefulCardDndProviderProps } from './components/StatefulCardDndProvider';`
  </action>
  <verify>`npx vitest run src/components/StatefulCardDndProvider/` -- all tests pass. `npx tsc --noEmit` -- no type errors.</verify>
  <done>StatefulCardDndProvider tested end-to-end with both context and Redux providers. Barrel exports updated. DnD events automatically trigger state actions.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/components/StatefulCardDndProvider/` -- all tests pass
2. `npx tsc --noEmit` -- no type errors
3. StatefulCardDndProvider auto-dispatches MOVE_CARD when card dragged between zones
4. Works with both GameProvider and ReduxGameProvider
5. autoDispatch=false disables automatic state updates
6. User callbacks still fire alongside auto-dispatch
</verification>

<success_criteria>
- Dragging a card between zones automatically dispatches MOVE_CARD to state
- StatefulCardDndProvider works as drop-in replacement for CardDndProvider
- Works transparently with both context and Redux providers
- autoDispatch prop allows opting out of automatic state updates
- User-provided onDragEnd callbacks still fire
- Exported from main entry point
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-06-SUMMARY.md`
</output>
