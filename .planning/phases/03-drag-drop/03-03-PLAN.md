---
phase: 03-drag-drop
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/CardDragOverlay/CardDragOverlay.tsx
  - src/components/CardDragOverlay/CardDragOverlay.types.ts
  - src/components/CardDragOverlay/CardDragOverlay.module.css
  - src/components/CardDragOverlay/CardDragOverlay.test.tsx
  - src/components/CardDragOverlay/index.ts
  - src/components/DroppableZone/DroppableZone.tsx
  - src/components/DroppableZone/DroppableZone.types.ts
  - src/components/DroppableZone/DroppableZone.test.tsx
  - src/components/DroppableZone/index.ts
autonomous: true

must_haves:
  truths:
    - "A drag preview shows the card being dragged at cursor position"
    - "Drop zones visually indicate when a card can be dropped (highlight state)"
    - "Drop zones show different visual states for idle, active (something dragging), and hover (over this zone)"
    - "Multi-card drag preview shows stacked cards with count badge"
  artifacts:
    - path: "src/components/CardDragOverlay/CardDragOverlay.tsx"
      provides: "Drag preview overlay component"
      min_lines: 30
    - path: "src/components/DroppableZone/DroppableZone.tsx"
      provides: "Drop zone with useDroppable integration"
      min_lines: 30
  key_links:
    - from: "src/components/CardDragOverlay/CardDragOverlay.tsx"
      to: "@dnd-kit/core"
      via: "DragOverlay component"
      pattern: "DragOverlay"
    - from: "src/components/DroppableZone/DroppableZone.tsx"
      to: "@dnd-kit/core"
      via: "useDroppable hook"
      pattern: "useDroppable"
    - from: "src/components/DroppableZone/DroppableZone.tsx"
      to: "src/components/DropZone/DropZone.tsx"
      via: "renders existing DropZone with DnD-driven state"
      pattern: "<DropZone"
---

<objective>
Create CardDragOverlay (drag preview) and DroppableZone (drop target) components.

Purpose: CardDragOverlay provides the floating card clone during drag (DND-04). DroppableZone wraps the existing DropZone with useDroppable to drive visual states from DnD context (DND-03). These two components plus DraggableCard (Plan 02) form the three building blocks that CardDndProvider assembles.

Output: CardDragOverlay and DroppableZone components with types, styles, and tests.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-drag-drop/03-RESEARCH.md
@.planning/phases/03-drag-drop/03-01-SUMMARY.md

@src/components/DropZone/DropZone.tsx
@src/components/DropZone/DropZone.types.ts
@src/components/Card/Card.tsx
@src/components/Card/Card.types.ts
@src/types/dnd.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardDragOverlay component</name>
  <files>src/components/CardDragOverlay/CardDragOverlay.types.ts, src/components/CardDragOverlay/CardDragOverlay.module.css, src/components/CardDragOverlay/CardDragOverlay.tsx, src/components/CardDragOverlay/CardDragOverlay.test.tsx, src/components/CardDragOverlay/index.ts</files>
  <action>
    1. Create `src/components/CardDragOverlay/CardDragOverlay.types.ts`:
       - `CardDragOverlayProps`:
         - `activeCard: CardData | null` -- the card currently being dragged (null = nothing dragging)
         - `selectedCards?: CardData[]` -- for multi-card drag, additional selected cards
         - `previewMode?: DragPreviewMode` -- 'original' (default), 'translucent', 'miniature'
         - `dropAnimation?: object` -- custom drop animation config (optional override)
         - `zIndex?: number` -- z-index for overlay (default 999)

    2. Create `src/components/CardDragOverlay/CardDragOverlay.module.css`:
       ```css
       .overlay {
         pointer-events: none;
       }

       .overlay--translucent {
         opacity: 0.7;
       }

       .overlay--miniature {
         transform: scale(0.75);
       }

       .multiStack {
         position: relative;
       }

       .multiCard {
         position: absolute;
         top: 0;
         left: 0;
       }

       .multiCard:first-child {
         position: relative;
       }

       .badge {
         position: absolute;
         top: -8px;
         right: -8px;
         background: #e74c3c;
         color: white;
         border-radius: 50%;
         width: 24px;
         height: 24px;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 12px;
         font-weight: bold;
         z-index: 10;
       }
       ```

    3. Create `src/components/CardDragOverlay/CardDragOverlay.tsx`:
       - Import `DragOverlay`, `defaultDropAnimationSideEffects` from `@dnd-kit/core`
       - Import `Card` from `../Card`
       - CRITICAL: DragOverlay is ALWAYS mounted. Only its children are conditionally rendered. This ensures drop animation works (see Research pitfall 4).
       - Default drop animation config:
         ```typescript
         const defaultDropAnim = {
           duration: 200,
           easing: 'cubic-bezier(0.18, 0.67, 0.6, 1.22)',
           sideEffects: defaultDropAnimationSideEffects({
             styles: { active: { opacity: '0.5' } },
           }),
         };
         ```
       - Render logic:
         - If `activeCard` is null, render `<DragOverlay>{null}</DragOverlay>` (always mounted!)
         - If `selectedCards` has 2+ items, render multi-card stack preview:
           - Show up to 3 cards stacked with offset (top: i*4px, left: i*2px)
           - If more than 3, show badge with "+N" count
         - If single card, render `<Card card={activeCard} isFaceUp />`
         - Apply preview mode class: translucent -> opacity class, miniature -> scale class
       - Pass `zIndex` and `dropAnimation` to DragOverlay component

    4. Create `src/components/CardDragOverlay/CardDragOverlay.test.tsx`:
       - Mock `@dnd-kit/core` DragOverlay as a simple div that renders children
       - Test: "always renders DragOverlay element" -- even when activeCard is null
       - Test: "renders Card when activeCard is provided" -- verify Card component appears
       - Test: "renders nothing inside DragOverlay when activeCard is null" -- DragOverlay mounted, children null
       - Test: "applies translucent class for translucent preview mode"
       - Test: "applies miniature class for miniature preview mode"
       - Test: "renders multi-card stack for selectedCards with 2+ items"
       - Test: "shows badge with count for 4+ selected cards" -- badge shows "+1" for 4 cards
       - Test: "limits visual stack to 3 cards" -- only first 3 rendered as cards

    5. Create `src/components/CardDragOverlay/index.ts`:
       ```typescript
       export { CardDragOverlay } from './CardDragOverlay';
       export type { CardDragOverlayProps } from './CardDragOverlay.types';
       ```
  </action>
  <verify>
    - `npx vitest run src/components/CardDragOverlay/` passes all tests
    - `npx tsc --noEmit` has no type errors
  </verify>
  <done>CardDragOverlay renders always-mounted DragOverlay with single-card, multi-card stack, and preview mode support</done>
</task>

<task type="auto">
  <name>Task 2: Create DroppableZone component wrapping existing DropZone</name>
  <files>src/components/DroppableZone/DroppableZone.types.ts, src/components/DroppableZone/DroppableZone.tsx, src/components/DroppableZone/DroppableZone.test.tsx, src/components/DroppableZone/index.ts</files>
  <action>
    1. Create `src/components/DroppableZone/DroppableZone.types.ts`:
       - `DroppableZoneProps`:
         - `id: string` -- unique zone identifier for dnd-kit (required)
         - `accepts?: string[]` -- card types this zone accepts (e.g., ['card'])
         - `onValidate?: DropValidationFn` -- custom validation callback
         - `children?: ReactNode` -- zone content
         - `emptyState?: DropZoneEmptyState` -- pass through to DropZone
         - `label?: string` -- pass through to DropZone
         - `className?: string` -- additional CSS class
         - `disabled?: boolean` -- disable drop acceptance
       - Import `DropValidationFn` from `../../types`
       - Import `DropZoneEmptyState` from `../DropZone/DropZone.types`

    2. Create `src/components/DroppableZone/DroppableZone.tsx`:
       - Import `useDroppable` from `@dnd-kit/core`
       - Import existing `DropZone` from `../DropZone`
       - Import `DragItemData` from `../../types`
       - Use `useDroppable({ id, data: { accepts, onValidate }, disabled })`
       - Derive `DropZoneVisualState` from DnD context:
         ```typescript
         let visualState: DropZoneVisualState = 'idle';
         if (active) {
           const dragData = active.data.current as DragItemData | undefined;
           const isAccepted = accepts
             ? accepts.includes(dragData?.type ?? '')
             : true;
           const isValid = onValidate && dragData?.card
             ? onValidate(dragData.card)
             : isAccepted;

           visualState = isOver
             ? (isValid ? 'hover' : 'idle')
             : 'active';
         }
         ```
       - Render `<DropZone ref={setNodeRef} state={visualState} ...passthrough>` -- the existing DropZone already supports `state` prop and renders visual feedback
       - NOTE: The existing DropZone does NOT use forwardRef. If needed, update DropZone to accept ref (it's a simple div container, add forwardRef). Alternatively, wrap with a div that gets the ref and render DropZone inside. Prefer the wrapping approach to minimize changes to the Phase 2 component.

    3. Create `src/components/DroppableZone/DroppableZone.test.tsx`:
       - Mock `@dnd-kit/core` useDroppable to return controlled values
       - Test: "renders DropZone with idle state when nothing is dragging" -- mock active: null, isOver: false
       - Test: "renders DropZone with active state when something is dragging" -- mock active: { id: 'x', data: { current: { type: 'card' } } }, isOver: false
       - Test: "renders DropZone with hover state when dragged item is over zone" -- mock active with data, isOver: true
       - Test: "shows idle state when dragged item is over but not accepted" -- accepts=['special'], drag type='card', isOver: true
       - Test: "calls onValidate when item is over zone" -- mock onValidate, verify called with card data
       - Test: "passes children through to DropZone"
       - Test: "passes label and emptyState through to DropZone"
       - Test: "sets ref on wrapper element" -- verify setNodeRef is called

    4. Create `src/components/DroppableZone/index.ts`:
       ```typescript
       export { DroppableZone } from './DroppableZone';
       export type { DroppableZoneProps } from './DroppableZone.types';
       ```
  </action>
  <verify>
    - `npx vitest run src/components/DroppableZone/` passes all tests
    - `npx tsc --noEmit` has no type errors
    - `npx vitest run` -- all existing 201+ tests still pass
  </verify>
  <done>DroppableZone wraps existing DropZone with useDroppable, driving visual state from DnD context with validation support</done>
</task>

</tasks>

<verification>
- `npx vitest run src/components/CardDragOverlay/ src/components/DroppableZone/` passes all tests
- `npx tsc --noEmit` -- zero type errors
- CardDragOverlay always mounts DragOverlay (children conditional, not the overlay itself)
- DroppableZone drives DropZone visual state from useDroppable context
- Validation works: accepts filter and onValidate callback both respected
- Multi-card overlay shows stacked preview with badge count
</verification>

<success_criteria>
- CardDragOverlay renders floating card clone during drag with configurable preview modes
- Multi-card drag preview shows up to 3 stacked cards with "+N" badge
- DragOverlay is always mounted (children conditionally rendered) for proper drop animation
- DroppableZone integrates useDroppable with existing DropZone visual states
- Drop validation supports both accepts array and onValidate callback
- Visual states transition correctly: idle -> active (something dragging) -> hover (over this zone)
- All existing tests continue passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-drag-drop/03-03-SUMMARY.md`
</output>
