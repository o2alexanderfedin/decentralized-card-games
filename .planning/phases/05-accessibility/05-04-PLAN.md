---
phase: 05-accessibility
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/CardDndProvider/CardDndProvider.tsx
  - src/components/CardDndProvider/CardDndProvider.types.ts
  - src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx
  - src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts
  - src/components/DraggableCard/DraggableCard.tsx
autonomous: true

must_haves:
  truths:
    - "Screen reader announces card identity when drag starts (e.g. 'Picked up Ace of Spades from hand')"
    - "Screen reader announces drop zone name during drag over"
    - "Screen reader announces successful drop or cancellation"
    - "Screen reader instructions tell user how to pick up, move, and drop cards"
    - "DraggableCard has aria-roledescription='draggable card' for context"
    - "StatefulCardDndProvider inherits same accessibility prop forwarding"
  artifacts:
    - path: "src/components/CardDndProvider/CardDndProvider.tsx"
      provides: "Custom announcements and screenReaderInstructions on DndContext"
      contains: "accessibility"
    - path: "src/components/DraggableCard/DraggableCard.tsx"
      provides: "Enhanced ARIA attributes for draggable cards"
      contains: "aria-roledescription"
  key_links:
    - from: "src/components/CardDndProvider/CardDndProvider.tsx"
      to: "src/utils/a11y.ts"
      via: "formatCardForSpeech for announcement text"
      pattern: "formatCardForSpeech"
    - from: "src/components/CardDndProvider/CardDndProvider.tsx"
      to: "@dnd-kit/core DndContext"
      via: "accessibility prop with announcements and screenReaderInstructions"
      pattern: "accessibility.*announcements"
---

<objective>
Add custom drag-and-drop announcements and screen reader instructions to CardDndProvider so screen readers provide meaningful feedback during card drag operations.

Purpose: Covers A11Y-05 (screen reader announcements for card actions) and A11Y-08 (keyboard-accessible DnD alternative -- dnd-kit KeyboardSensor is already configured). This plan customizes dnd-kit's built-in accessibility with card-game-specific context instead of generic "item 1" announcements.
Output: CardDndProvider and StatefulCardDndProvider emit card-aware announcements. DraggableCard has enhanced ARIA descriptions.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-accessibility/05-CONTEXT.md
@.planning/phases/05-accessibility/05-RESEARCH.md
@.planning/phases/05-accessibility/05-01-SUMMARY.md
@src/components/CardDndProvider/CardDndProvider.tsx
@src/components/CardDndProvider/CardDndProvider.types.ts
@src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx
@src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts
@src/components/DraggableCard/DraggableCard.tsx
@src/utils/a11y.ts
@src/types/dnd.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Custom DnD announcements and screen reader instructions</name>
  <files>src/components/CardDndProvider/CardDndProvider.tsx, src/components/CardDndProvider/CardDndProvider.types.ts, src/components/StatefulCardDndProvider/StatefulCardDndProvider.tsx, src/components/StatefulCardDndProvider/StatefulCardDndProvider.types.ts</files>
  <action>
**CardDndProvider.tsx:**

1. Import `formatCardForSpeech` from `../../utils/a11y`
2. Import `Announcements, ScreenReaderInstructions` types from `@dnd-kit/core`
3. Import `DragItemData` type (already imported)

4. Create card-specific announcements object (outside the component, or memoized inside):
   ```typescript
   const cardAnnouncements: Announcements = {
     onDragStart({ active }) {
       const data = active.data.current as DragItemData | undefined;
       if (!data?.card) return 'Picked up item.';
       const cardName = formatCardForSpeech(data.card);
       const zone = data.sourceZoneId ?? 'the board';
       return `Picked up ${cardName} from ${zone}. Use arrow keys to move between drop zones. Press Space or Enter to drop, Escape to cancel.`;
     },
     onDragOver({ active, over }) {
       const data = active.data.current as DragItemData | undefined;
       const cardName = data?.card ? formatCardForSpeech(data.card) : 'Item';
       if (over) {
         return `${cardName} is over ${String(over.id)}.`;
       }
       return `${cardName} is not over a drop zone.`;
     },
     onDragEnd({ active, over }) {
       const data = active.data.current as DragItemData | undefined;
       const cardName = data?.card ? formatCardForSpeech(data.card) : 'Item';
       if (over) {
         return `${cardName} was dropped on ${String(over.id)}.`;
       }
       return `${cardName} was returned to its original position.`;
     },
     onDragCancel({ active }) {
       const data = active.data.current as DragItemData | undefined;
       const cardName = data?.card ? formatCardForSpeech(data.card) : 'Item';
       return `Dragging ${cardName} was cancelled. Card returned to original position.`;
     },
   };
   ```

5. Create screen reader instructions:
   ```typescript
   const cardScreenReaderInstructions: ScreenReaderInstructions = {
     draggable: 'To pick up this card, press Space or Enter. Use arrow keys to move between drop zones. Press Space or Enter to drop, or Escape to cancel.',
   };
   ```

6. Add the `accessibility` prop to DndContext:
   ```tsx
   <DndContext
     sensors={sensors}
     collisionDetection={collisionDetection ?? closestCorners}
     onDragStart={handleDragStart}
     onDragOver={handleDragOver}
     onDragEnd={handleDragEnd}
     onDragCancel={handleDragCancel}
     autoScroll={autoScroll ?? false}
     accessibility={{
       announcements: cardAnnouncements,
       screenReaderInstructions: cardScreenReaderInstructions,
       restoreFocus: true,
     }}
   >
   ```

   IMPORTANT: The dnd-kit v6 API nests announcements under `accessibility` prop (NOT as direct props on DndContext). Verified from DndContextProps type:
   ```typescript
   accessibility?: {
     announcements?: Announcements;
     container?: Element;
     restoreFocus?: boolean;
     screenReaderInstructions?: ScreenReaderInstructions;
   }
   ```

7. Set `restoreFocus: true` so focus returns to the dragged element after drop (important for keyboard users).

**CardDndProvider.types.ts:**
No changes needed -- the accessibility config is internal, not exposed as a prop. The component always provides card-specific announcements.

**StatefulCardDndProvider.tsx:**
No changes needed to this file directly -- it wraps CardDndProvider which now has the accessibility prop. The announcements flow through automatically.

**StatefulCardDndProvider.types.ts:**
No changes needed -- inherits from CardDndProviderProps.
  </action>
  <verify>Run `npx vitest run src/components/CardDndProvider/ src/components/StatefulCardDndProvider/` -- existing tests pass. Run `npx tsc --noEmit` -- no type errors.</verify>
  <done>DndContext has custom card-aware announcements. Screen reader announces "Picked up Ace of Spades from hand" instead of generic "Picked up draggable item 1".</done>
</task>

<task type="auto">
  <name>Task 2: DraggableCard ARIA enhancements</name>
  <files>src/components/DraggableCard/DraggableCard.tsx</files>
  <action>
1. Import `formatCardForSpeech` from `../../utils/a11y`

2. Add `aria-roledescription="draggable card"` to the wrapper div. This tells screen readers the element is a "draggable card" rather than generic "draggable item".

3. Add a descriptive `aria-label` to the wrapper div based on the card:
   ```typescript
   const dragAriaLabel = useMemo(() => {
     if (!resolvedCardData) return 'Draggable card';
     const cardName = formatCardForSpeech(resolvedCardData);
     return disabled ? `${cardName}, dragging disabled` : cardName;
   }, [resolvedCardData, disabled]);
   ```
   Apply: `aria-label={dragAriaLabel}`

4. When `isDragging` is true, add `aria-hidden="true"` to the wrapper div since the DragOverlay shows the visible card. The source card is opacity:0 and should be hidden from screen readers too:
   ```typescript
   aria-hidden={isDragging || undefined}
   ```

5. The dnd-kit `{...attributes}` spread already adds `role`, `tabIndex`, `aria-describedby` (linking to screen reader instructions), and `aria-pressed`. Keep the spread in place.

6. Ensure the `aria-roledescription` and `aria-label` are placed AFTER the `{...attributes}` spread so they override any generic dnd-kit attributes.

The final wrapper div should look like:
```tsx
<div
  ref={setNodeRef}
  className={wrapperClasses}
  style={{ transform: transformStyle, ...style }}
  data-testid={`draggable-card-${id}`}
  {...attributes}
  {...listeners}
  aria-roledescription="draggable card"
  aria-label={dragAriaLabel}
  aria-hidden={isDragging || undefined}
>
```
  </action>
  <verify>Run `npx vitest run src/components/DraggableCard/` -- existing tests pass. Run `npx tsc --noEmit` -- no type errors.</verify>
  <done>DraggableCard announces as "draggable card" with card name. While dragging, source element is aria-hidden. Screen reader instructions from DndContext are linked via aria-describedby (dnd-kit built-in).</done>
</task>

</tasks>

<verification>
Run `npx vitest run` -- all tests pass.
Run `npx tsc --noEmit` -- no TypeScript errors.
Grep for `accessibility` in CardDndProvider.tsx confirms the prop is set.
Grep for `aria-roledescription` in DraggableCard.tsx confirms the attribute is present.
</verification>

<success_criteria>
- CardDndProvider passes custom announcements to DndContext via accessibility prop
- Announcements use card names (e.g. "Ace of Spades") not element IDs
- Screen reader instructions explain Space/Enter to pick up, arrows to move, Escape to cancel
- restoreFocus is enabled for keyboard user return after drop
- DraggableCard has aria-roledescription and card-specific aria-label
- Dragging source card is aria-hidden (DragOverlay shows the visible clone)
- StatefulCardDndProvider inherits accessibility automatically
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-accessibility/05-04-SUMMARY.md`
</output>
