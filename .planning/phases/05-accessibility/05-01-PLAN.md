---
phase: 05-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/a11y.ts
  - src/utils/a11y.test.ts
  - src/utils/index.ts
  - src/hooks/useRovingTabIndex.ts
  - src/hooks/useRovingTabIndex.test.ts
  - src/hooks/useKeyboardShortcuts.ts
  - src/hooks/useKeyboardShortcuts.test.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "formatCardForSpeech returns natural language card identity (e.g. 'Ace of Spades')"
    - "formatCardLabel includes position, total, and location context"
    - "Face-down cards format as 'Face-down card' without revealing identity"
    - "useRovingTabIndex tracks active index and returns getTabIndex/handleKeyDown"
    - "Arrow keys cycle through items wrapping at boundaries"
    - "Home/End jump to first/last item"
    - "useKeyboardShortcuts fires registered callbacks on key press"
    - "Shortcuts are suppressed when focus is in INPUT or TEXTAREA"
    - "Modifier keys (Ctrl, Meta, Alt) prevent shortcut activation"
  artifacts:
    - path: "src/utils/a11y.ts"
      provides: "Card announcement text builders, RANK_NAMES and SUIT_NAMES maps"
      exports: ["formatCardForSpeech", "formatCardLabel", "formatFaceDownLabel", "RANK_NAMES", "SUIT_NAMES"]
    - path: "src/utils/a11y.test.ts"
      provides: "Tests for all a11y utility functions"
      min_lines: 40
    - path: "src/hooks/useRovingTabIndex.ts"
      provides: "Roving tabindex hook for composite widget navigation"
      exports: ["useRovingTabIndex"]
    - path: "src/hooks/useRovingTabIndex.test.ts"
      provides: "Tests for roving tabindex hook"
      min_lines: 40
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "Game-level keyboard shortcut registry"
      exports: ["useKeyboardShortcuts"]
    - path: "src/hooks/useKeyboardShortcuts.test.ts"
      provides: "Tests for keyboard shortcuts hook"
      min_lines: 30
  key_links:
    - from: "src/utils/a11y.ts"
      to: "src/types/card.ts"
      via: "imports CardData, Rank, Suit types"
      pattern: "import.*CardData.*from"
    - from: "src/hooks/useRovingTabIndex.ts"
      to: "React hooks"
      via: "useState, useCallback"
      pattern: "import.*useState.*from.*react"
---

<objective>
Create accessibility utility functions and hooks that other Phase 5 plans depend on.

Purpose: Establishes the foundational helpers (card speech formatters, roving tabindex, keyboard shortcuts) that Plans 03, 04, and 05 will consume when enhancing components.
Output: Three new modules (a11y.ts, useRovingTabIndex.ts, useKeyboardShortcuts.ts) with full test coverage.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-accessibility/05-CONTEXT.md
@.planning/phases/05-accessibility/05-RESEARCH.md
@src/types/card.ts
@src/utils/index.ts
@src/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: A11Y utility functions</name>
  <files>src/utils/a11y.ts, src/utils/a11y.test.ts, src/utils/index.ts</files>
  <action>
Create `src/utils/a11y.ts` with card announcement text builders:

1. Export `RANK_NAMES` map: `Record<Rank, string>` mapping rank codes to full names:
   - '2'-'9' map to themselves, 'T' -> 'Ten', 'J' -> 'Jack', 'Q' -> 'Queen', 'K' -> 'King', 'A' -> 'Ace'

2. Export `SUIT_NAMES` map: `Record<Suit, string>` mapping suit identifiers to full names:
   - 'spades' -> 'Spades', 'hearts' -> 'Hearts', 'diamonds' -> 'Diamonds', 'clubs' -> 'Clubs'

3. Export `formatCardForSpeech(card: CardData): string` - returns natural language card name:
   - Example: `{ suit: 'spades', rank: 'A' }` -> `"Ace of Spades"`
   - Used for DnD announcements and ARIA labels

4. Export `formatCardLabel(card: CardData, position: number, total: number, location: string): string` - returns full context label:
   - Example: `"Ace of Spades, card 3 of 7 in your hand"`
   - Used for screen reader labels in containers

5. Export `formatFaceDownLabel(position: number, total: number, location: string): string` - returns label without revealing identity:
   - Example: `"Face-down card, card 3 of 7 in deck"`
   - Critical: must NEVER include card identity for face-down cards to preserve game secrecy

Import `Rank`, `Suit`, `CardData` from `../types/card`.

Create `src/utils/a11y.test.ts` testing:
- All 13 ranks map to correct names (especially T -> Ten, J/Q/K/A -> face names)
- All 4 suits map to correct names
- formatCardForSpeech with multiple cards
- formatCardLabel includes position, total, location
- formatFaceDownLabel never includes card identity

Update `src/utils/index.ts` to re-export all exports from `./a11y`.
  </action>
  <verify>Run `npx vitest run src/utils/a11y.test.ts` -- all tests pass.</verify>
  <done>a11y.ts exports 5 items (RANK_NAMES, SUIT_NAMES, formatCardForSpeech, formatCardLabel, formatFaceDownLabel), all tested.</done>
</task>

<task type="auto">
  <name>Task 2: Roving tabindex and keyboard shortcuts hooks</name>
  <files>src/hooks/useRovingTabIndex.ts, src/hooks/useRovingTabIndex.test.ts, src/hooks/useKeyboardShortcuts.ts, src/hooks/useKeyboardShortcuts.test.ts, src/hooks/index.ts</files>
  <action>
Create `src/hooks/useRovingTabIndex.ts`:

```typescript
interface UseRovingTabIndexReturn {
  activeIndex: number;
  setActiveIndex: (index: number) => void;
  getTabIndex: (index: number) => 0 | -1;
  handleKeyDown: (event: React.KeyboardEvent, index: number) => void;
}
```

Implementation:
- `activeIndex` state initialized to 0
- `getTabIndex(index)` returns 0 if index === activeIndex, else -1
- `handleKeyDown(event, index)` handles:
  - ArrowRight/ArrowDown: next item (wraps to 0 at end), preventDefault
  - ArrowLeft/ArrowUp: previous item (wraps to end at 0), preventDefault
  - Home: jump to index 0, preventDefault
  - End: jump to last index (itemCount - 1), preventDefault
- When activeIndex changes, the hook does NOT manage focus directly -- the consuming component is responsible for calling `.focus()` on the element at the new activeIndex (this keeps the hook reusable)
- Reset activeIndex to 0 if it exceeds itemCount - 1 (handles card removal)
- useCallback for handleKeyDown with [itemCount] dependency

Create `src/hooks/useRovingTabIndex.test.ts`:
- Use renderHook from @testing-library/react
- Test ArrowRight cycles forward and wraps
- Test ArrowLeft cycles backward and wraps
- Test Home jumps to 0, End jumps to last
- Test getTabIndex returns 0 only for activeIndex
- Test activeIndex resets when itemCount shrinks below it

Create `src/hooks/useKeyboardShortcuts.ts`:

```typescript
interface KeyboardShortcut {
  key: string;       // Single character like 'D', 'P', 'F'
  action: () => void;
  label: string;     // Human-readable description
  enabled?: boolean; // Default true
}
```

Implementation:
- Accept `shortcuts: KeyboardShortcut[]` parameter
- useEffect adds document-level keydown listener
- Guard conditions (return early, don't fire):
  - e.ctrlKey, e.metaKey, or e.altKey is true
  - e.target is INPUT, TEXTAREA, or has contentEditable
- Match: case-insensitive comparison of e.key to shortcut.key
- On match: e.preventDefault() then call shortcut.action()
- Clean up listener on unmount
- Memoize handler with useCallback, depend on shortcuts reference

Create `src/hooks/useKeyboardShortcuts.test.ts`:
- Test matching shortcut fires action
- Test modifier keys suppress shortcuts
- Test disabled shortcuts don't fire
- Test cleanup removes listener

Update `src/hooks/index.ts` to add:
```typescript
export { useRovingTabIndex } from './useRovingTabIndex';
export { useKeyboardShortcuts } from './useKeyboardShortcuts';
export type { KeyboardShortcut } from './useKeyboardShortcuts';
```
  </action>
  <verify>Run `npx vitest run src/hooks/useRovingTabIndex.test.ts src/hooks/useKeyboardShortcuts.test.ts` -- all tests pass.</verify>
  <done>Both hooks exported from hooks/index.ts with full test coverage. useRovingTabIndex handles Arrow/Home/End navigation. useKeyboardShortcuts handles document-level shortcut registration.</done>
</task>

</tasks>

<verification>
Run `npx vitest run src/utils/a11y.test.ts src/hooks/useRovingTabIndex.test.ts src/hooks/useKeyboardShortcuts.test.ts` -- all tests pass with no failures.
Run `npx tsc --noEmit` -- no TypeScript errors.
</verification>

<success_criteria>
- a11y.ts utility functions produce correct card speech strings
- Face-down card labels never reveal card identity
- useRovingTabIndex navigates correctly with Arrow/Home/End keys
- useKeyboardShortcuts fires actions on registered keys, suppresses with modifiers
- All new modules have test coverage
- Barrel exports updated in utils/index.ts and hooks/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/05-accessibility/05-01-SUMMARY.md`
</output>
