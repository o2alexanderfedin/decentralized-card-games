---
phase: 05-accessibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test-setup.ts
  - src/components/Card/Card.module.css
  - src/components/Hand/Hand.module.css
  - src/components/DraggableCard/DraggableCard.module.css
  - src/components/Deck/Deck.module.css
  - src/components/CardStack/CardStack.module.css
  - src/components/DropZone/DropZone.module.css
  - src/hooks/useCardFlip.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "vitest-axe matchers are available in all test files via test-setup.ts"
    - "Keyboard focus shows browser default outline on :focus-visible for all interactive card elements"
    - "Mouse click does not show focus outline (focus:not(:focus-visible) hides it)"
    - "Touch targets meet 44x44px minimum via invisible padding expansion"
    - "Card flip uses opacity crossfade (no rotation) when prefers-reduced-motion is active"
    - "Layout animations respect reduced motion (instant transitions, no spring physics)"
  artifacts:
    - path: "src/test-setup.ts"
      provides: "vitest-axe matchers registration"
      contains: "vitest-axe"
    - path: "src/components/Card/Card.module.css"
      provides: "Focus-visible styles and touch target expansion"
      contains: "focus-visible"
    - path: "src/hooks/useCardFlip.ts"
      provides: "Reduced motion crossfade alternative to 3D rotation"
      contains: "crossfade"
  key_links:
    - from: "src/test-setup.ts"
      to: "vitest-axe/matchers"
      via: "expect.extend"
      pattern: "expect\\.extend"
    - from: "src/hooks/useCardFlip.ts"
      to: "src/hooks/usePrefersReducedMotion.ts"
      via: "conditional animation path"
      pattern: "prefersReducedMotion|reducedMotion"
---

<objective>
Install vitest-axe for accessibility testing, add CSS :focus-visible styles and touch target expansion to all interactive components, and enhance reduced motion handling in card flip animation.

Purpose: Establishes testing infrastructure and visual accessibility foundations (focus indicators, touch targets, reduced motion) that all subsequent plans benefit from. These are cross-cutting concerns independent of ARIA/hook work in Plan 01.
Output: vitest-axe ready for use, all CSS modules updated with focus and touch styles, useCardFlip enhanced with crossfade for reduced motion.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-accessibility/05-CONTEXT.md
@.planning/phases/05-accessibility/05-RESEARCH.md
@src/test-setup.ts
@src/components/Card/Card.module.css
@src/components/Hand/Hand.module.css
@src/hooks/useCardFlip.ts
@src/hooks/usePrefersReducedMotion.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vitest-axe and add CSS focus/touch styles</name>
  <files>package.json, src/test-setup.ts, src/components/Card/Card.module.css, src/components/Hand/Hand.module.css, src/components/DraggableCard/DraggableCard.module.css, src/components/Deck/Deck.module.css, src/components/CardStack/CardStack.module.css, src/components/DropZone/DropZone.module.css</files>
  <action>
1. Install vitest-axe:
   ```bash
   npm install --save-dev vitest-axe
   ```

2. Update `src/test-setup.ts` to add vitest-axe matchers:
   ```typescript
   import '@testing-library/jest-dom/vitest';
   import * as matchers from 'vitest-axe/matchers';
   expect.extend(matchers);
   ```
   Also add the vitest-axe type reference if needed for `toHaveNoViolations()` to be recognized:
   ```typescript
   import 'vitest-axe/extend-expect';
   ```
   Check vitest-axe docs for exact import -- may need `import { toHaveNoViolations } from 'vitest-axe'` and `expect.extend(toHaveNoViolations)` instead.

3. Add `:focus-visible` styles to **Card.module.css** (on `.card` element):
   ```css
   .card:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .card:focus:not(:focus-visible) {
     outline: none;
   }
   ```

4. Add touch target expansion to **Card.module.css** (on `.card` element):
   ```css
   .card {
     position: relative; /* already set */
   }
   .card::before {
     content: '';
     position: absolute;
     top: 50%;
     left: 50%;
     min-width: 44px;
     min-height: 44px;
     transform: translate(-50%, -50%);
   }
   ```

5. Add `:focus-visible` styles to **Hand.module.css** (on `.cardSlot` element):
   ```css
   .cardSlot:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .cardSlot:focus:not(:focus-visible) {
     outline: none;
   }
   ```

6. Add `:focus-visible` styles to **DraggableCard.module.css** (on `.draggable` element):
   ```css
   .draggable:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .draggable:focus:not(:focus-visible) {
     outline: none;
   }
   ```

7. Add `:focus-visible` styles to **Deck.module.css** (on the deck container that has role="button"):
   ```css
   .deck:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .deck:focus:not(:focus-visible) {
     outline: none;
   }
   ```

8. Add `:focus-visible` and selection distinction styles to **CardStack.module.css**:
   ```css
   .cardSlot:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .cardSlot:focus:not(:focus-visible) {
     outline: none;
   }
   ```

9. Add `:focus-visible` to **DropZone.module.css**:
   ```css
   .dropZone:focus-visible {
     outline: revert;
     outline-offset: 2px;
   }
   .dropZone:focus:not(:focus-visible) {
     outline: none;
   }
   ```

Per user decision: browser default outline for focus (guaranteed visibility), :focus-visible to hide on mouse click. Blue outline for focus vs green highlight for selected (green already exists in Hand.module.css cardSlot--selected filter:brightness).

Replace the existing `cardSlot--selected` filter with a green box-shadow to be visually distinct from focus:
```css
.cardSlot--selected {
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.6);
}
```
  </action>
  <verify>
Run `npm install` to ensure vitest-axe installed.
Run `npx vitest run --reporter=verbose 2>&1 | tail -5` to confirm existing tests still pass with new setup file.
  </verify>
  <done>vitest-axe installed and matchers registered. All 6 component CSS modules have :focus-visible styles. Card has 44x44px touch target expansion. Selected cards use green box-shadow distinct from blue focus outline.</done>
</task>

<task type="auto">
  <name>Task 2: Enhanced reduced motion for card flip</name>
  <files>src/hooks/useCardFlip.ts</files>
  <action>
Enhance `useCardFlip` to use an opacity-only crossfade when `prefers-reduced-motion` is active, instead of the current approach that just uses a stiff spring (which still rotates).

The hook currently receives spring config and always uses `useSpring` for rotateY. When reduced motion is preferred, the Card.tsx passes `{ stiffness: 1000, damping: 50 }` -- this still does a fast 3D rotation which can cause discomfort.

Modify `useCardFlip` to:
1. Accept an optional `reducedMotion?: boolean` parameter in `UseCardFlipOptions`
2. When `reducedMotion` is true:
   - Set `rotateY` to a constant 0 (no rotation at all) using `motionValue(0)` instead of `useSpring`
   - Use opacity-only crossfade with a fast linear transition (200-300ms)
   - Front opacity: 1 when faceUp, 0 when not (with ~250ms duration transition)
   - Back opacity: 0 when faceUp, 1 when not (with ~250ms duration transition)
   - `isAnimating` can be false since the transition is near-instant

IMPORTANT: Since React hooks must be called unconditionally, always call ALL hooks (useSpring, useTransform) regardless of reduced motion. Then conditionally return either the spring-based or crossfade-based motion values.

When reduced motion is active:
- The rotateY spring still exists but is set to 0 always
- Create separate crossfade opacity values using useSpring with `{ duration: 0.25 }` (250ms)
- Return the crossfade opacities instead of the transform-derived ones

Add a JSDoc comment noting the crossfade approach: "When reducedMotion is true, card flip uses a quick opacity crossfade (250ms) instead of 3D rotation, per WCAG prefers-reduced-motion guidance."

Update Card.tsx to pass `reducedMotion={prefersReducedMotion}` to useCardFlip, and remove the stiff spring override `spring: prefersReducedMotion ? { stiffness: 1000, damping: 50 } : spring`. The hook now handles reduced motion internally.
  </action>
  <verify>Run `npx vitest run src/hooks/useCardFlip.test.ts` -- existing tests still pass. Verify manually that the hook signature includes `reducedMotion` option.</verify>
  <done>useCardFlip uses opacity crossfade (no rotation) when reducedMotion is true. Card.tsx passes reducedMotion prop instead of stiff spring hack. Vestibular-safe card flipping.</done>
</task>

</tasks>

<verification>
Run `npx vitest run` -- all existing tests pass with vitest-axe setup.
Run `npx tsc --noEmit` -- no TypeScript errors from new imports or modified hook signature.
Grep for `:focus-visible` in all modified CSS modules confirms presence.
</verification>

<success_criteria>
- `vitest-axe` installed and `toHaveNoViolations` available in tests
- All interactive component CSS modules have :focus-visible / :focus:not(:focus-visible) rules
- Card component has 44x44px touch target expansion via ::before pseudo-element
- Selected cards use green box-shadow (visually distinct from blue focus outline)
- Card flip uses opacity crossfade under reduced motion (no 3D rotation)
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-accessibility/05-02-SUMMARY.md`
</output>
