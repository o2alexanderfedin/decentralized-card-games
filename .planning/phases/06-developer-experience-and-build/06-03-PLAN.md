---
phase: 06-developer-experience-and-build
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - vite.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npm run build` produces ESM and UMD bundles for the main entry"
    - "Redux entry is ESM-only (redux users always use bundlers)"
    - "Consumer bundlers can tree-shake unused components via sideEffects field"
    - "TypeScript users get full autocomplete via .d.ts files"
    - "Source maps are included in dist for debugging"
    - "Bundle size is monitored and enforced via size-limit"
  artifacts:
    - path: "vite.config.ts"
      provides: "Multi-entry build with ESM+UMD for main, ESM-only for redux"
      contains: "umd"
    - path: "package.json"
      provides: "exports map, sideEffects, size-limit config, build/size scripts"
      contains: "sideEffects"
  key_links:
    - from: "package.json"
      to: "dist/"
      via: "exports field"
      pattern: "exports.*dist"
    - from: "package.json"
      to: "size-limit"
      via: "size-limit config"
      pattern: "size-limit"
---

<objective>
Configure the Vite build for production distribution with ESM+UMD output, proper package.json exports, sideEffects for tree-shaking, and bundle size monitoring.

Purpose: This plan delivers the core build infrastructure (BUILD-01, BUILD-02, BUILD-03, DX-04, DX-05, DX-06, BUILD-06) so the library can be consumed via npm with tree-shakeable imports, UMD for CDN usage, TypeScript definitions, and enforced size budgets.
Output: Updated vite.config.ts, package.json with exports/sideEffects/size-limit, build scripts.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-developer-experience-and-build/06-RESEARCH.md
@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vite for ESM+UMD build with source maps</name>
  <files>vite.config.ts</files>
  <action>
Update `vite.config.ts` to produce ESM + UMD output:

**Strategy for UMD + multi-entry (from RESEARCH open question 1):**
The main entry (`src/index.ts`) gets both ESM and UMD formats. The redux entry (`src/redux/index.ts`) gets ESM-only since Redux users always use a module bundler. This avoids the UMD multi-entry incompatibility.

Implementation approach: Use rollup `output` as an array to produce different formats per entry. Or simpler: since Vite's multi-entry with `formats: ['es', 'umd']` only uses one global `name`, we can accept that both entries share the same `name` for UMD (consumers will use subpath imports for the redux entry anyway). But the cleaner approach is to separate:

**Recommended approach (two-pass build):**
Keep the existing multi-entry for ESM output. Add a separate build step for UMD of the main entry only. This can be done with a build script that runs two Vite builds.

**Simpler approach (single build, accept limitation):**
Use `formats: ['es', 'umd']` with `name: 'CardComponents'`. Vite will produce UMD for both entries, but only the main entry UMD is useful. The redux UMD shares the same global name - this is fine since it won't be used via UMD in practice.

**Choose the simpler approach.** Update vite.config.ts:

1. Change `formats: ['es', 'cjs']` to `formats: ['es', 'umd']`
2. Add `name: 'CardComponents'` to `build.lib`
3. Add `fileName: (format, entryName) => ...` to produce correct file names:
   - ESM: `${entryName}.js`
   - UMD: `${entryName}.umd.cjs`
4. Add `sourcemap: true` to `build`
5. Exclude stories from dts plugin: add `'src/**/*.stories.tsx'` to dts exclude
6. Add `@dnd-kit/core`, `@dnd-kit/utilities`, `@dnd-kit/modifiers` to rollup globals:
   ```
   '@dnd-kit/core': 'DndKitCore',
   '@dnd-kit/utilities': 'DndKitUtilities',
   '@dnd-kit/modifiers': 'DndKitModifiers',
   ```

After update, run `npm run build` to verify output files.
  </action>
  <verify>Run `npm run build` - should produce dist/ with: card-components.js (ESM), card-components.umd.cjs (UMD), card-components-redux.js (ESM), *.d.ts files, *.map files, and CSS file(s).</verify>
  <done>Build produces ESM + UMD for main entry, ESM for redux entry, with source maps and .d.ts type definitions.</done>
</task>

<task type="auto">
  <name>Task 2: Update package.json exports, sideEffects, and add bundle size monitoring</name>
  <files>package.json</files>
  <action>
Install size-limit:
```bash
npm install -D size-limit @size-limit/preset-small-lib
```

Update package.json with these changes:

1. **Update `main` and `module` fields** to point to UMD and ESM respectively:
   ```json
   "main": "./dist/card-components.umd.cjs",
   "module": "./dist/card-components.js",
   ```

2. **Update `exports` field** with correct paths and style subpath:
   ```json
   "exports": {
     ".": {
       "types": "./dist/index.d.ts",
       "import": "./dist/card-components.js",
       "require": "./dist/card-components.umd.cjs"
     },
     "./redux": {
       "types": "./dist/redux/index.d.ts",
       "import": "./dist/card-components-redux.js"
     },
     "./styles": "./dist/style.css"
   }
   ```
   Note: Remove `require` from `./redux` export since redux entry is ESM-only. The `./styles` export points to the CSS file produced by Vite (check actual filename after build - it may be `style.css` or `card-components.css`).

3. **Add `sideEffects` field:**
   ```json
   "sideEffects": ["**/*.css"]
   ```
   This tells consumer bundlers that only CSS imports have side effects; all JS/TS is tree-shakeable.

4. **Add `size-limit` config:**
   ```json
   "size-limit": [
     {
       "path": "dist/card-components.js",
       "limit": "60 kB"
     },
     {
       "path": "dist/card-components-redux.js",
       "limit": "10 kB"
     }
   ]
   ```

5. **Add size scripts:**
   ```json
   "size": "size-limit",
   "size:why": "size-limit --why"
   ```

6. **Update build script** if needed to ensure clean dist:
   ```json
   "build": "tsc --noEmit && vite build"
   ```
   (Keep as-is if already correct.)

After changes, run `npm run build && npm run size` to verify.
  </action>
  <verify>Run `npm run build && npm run size` - build should succeed and size-limit should report bundle sizes under the configured limits.</verify>
  <done>Package.json has correct exports map, sideEffects field, size-limit config, and all scripts. `npm run size` reports bundle sizes within budget.</done>
</task>

</tasks>

<verification>
1. `npm run build` produces ESM + UMD + .d.ts + source maps + CSS
2. `npm run size` reports bundle sizes within 60kb (main) and 10kb (redux) limits
3. `package.json` exports map resolves correctly for `.`, `./redux`, and `./styles`
4. `sideEffects: ["**/*.css"]` is set for tree-shaking
5. TypeScript declarations are generated and exports point to correct `.d.ts` paths
</verification>

<success_criteria>
- Build produces correct output formats (ESM + UMD for main, ESM for redux)
- Package.json exports enable `import { Card } from '@decentralized-games/cards'` and `import { gameSlice } from '@decentralized-games/cards/redux'`
- Tree-shaking works (sideEffects configured)
- Bundle size is monitored with enforced limits
- Source maps included for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/06-developer-experience-and-build/06-03-SUMMARY.md`
</output>
