---
phase: 07-cicd-foundation-deployment-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - .storybook/main.ts
autonomous: true

must_haves:
  truths:
    - "Merge to main triggers automatic deployment to GitHub Pages"
    - "Storybook is deployed to /storybook/ subdirectory"
    - ".nojekyll file prevents Jekyll filtering of Storybook assets"
    - "Deployment completes without OOM errors"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Deployment workflow configuration"
      contains: "actions/deploy-pages@v4"
    - path: ".storybook/main.ts"
      provides: "Storybook config with base path support"
      contains: "viteFinal"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "GitHub Pages"
      via: "actions/deploy-pages"
      pattern: "deploy-pages@v4"
    - from: ".storybook/main.ts"
      to: ".github/workflows/deploy.yml"
      via: "STORYBOOK_BASE environment variable"
      pattern: "STORYBOOK_BASE"
---

<objective>
Create the deployment workflow that builds and deploys the composite site to GitHub Pages when code is merged to main.

Purpose: Enable automatic deployment so the documentation site stays current with the codebase
Output: `.github/workflows/deploy.yml` and updated Storybook config for base path support
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cicd-foundation-deployment-infrastructure/07-CONTEXT.md
@.planning/phases/07-cicd-foundation-deployment-infrastructure/07-RESEARCH.md
@.storybook/main.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Storybook config for base path support</name>
  <files>.storybook/main.ts</files>
  <action>
    Modify `.storybook/main.ts` to add viteFinal configuration that sets the base path from environment variable.

    Add the following viteFinal function after the docs configuration:

    ```typescript
    viteFinal: async (config) => {
      // Set base path for GitHub Pages subdirectory deployment
      if (process.env.STORYBOOK_BASE) {
        config.base = process.env.STORYBOOK_BASE;
      }
      return config;
    },
    ```

    This allows the deploy workflow to set STORYBOOK_BASE=/decentralized-card-games/storybook/ when building for GitHub Pages, while local development continues to work at the root path.

    Per RESEARCH.md pitfall #4: This prevents 404s for CSS/JS assets when deployed to GitHub Pages subdirectory.
  </action>
  <verify>
    Config contains viteFinal: `grep -A 5 "viteFinal" .storybook/main.ts`
    TypeScript compiles: `npm run typecheck`
  </verify>
  <done>
    .storybook/main.ts has viteFinal that reads STORYBOOK_BASE env var
    TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deployment workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
    Create `.github/workflows/deploy.yml` with the following configuration:

    **Workflow name:** "Deploy to GitHub Pages"

    **Triggers:**
    - push to: main (production deployment)
    - workflow_dispatch (manual trigger)

    **Permissions (required for GitHub Pages OIDC deployment):**
    - contents: read
    - pages: write
    - id-token: write

    **Concurrency:**
    - group: 'pages'
    - cancel-in-progress: false (queue deployments, don't cancel)

    **Environment:**
    - NODE_OPTIONS: --max-old-space-size=4096

    **Jobs:**

    1. `build` (name: "Build Site")
       - actions/checkout@v6
       - actions/setup-node@v6 with node-version: '22', cache: 'npm'
       - npm ci
       - Build library: npm run build
       - Build Storybook with STORYBOOK_BASE env var:
         ```
         env:
           STORYBOOK_BASE: /decentralized-card-games/storybook/
         run: npm run build-storybook
         ```
       - Compose site directory:
         ```bash
         mkdir -p site-dist/storybook
         cp -r storybook-static/* site-dist/storybook/
         touch site-dist/.nojekyll
         echo "Site composed successfully"
         ls -la site-dist/
         ```
       - Upload pages artifact: actions/upload-pages-artifact@v4 with path: site-dist/

    2. `deploy` (name: "Deploy to GitHub Pages")
       - needs: build
       - environment:
           name: github-pages
           url: ${{ steps.deployment.outputs.page_url }}
       - Deploy: actions/deploy-pages@v4 (id: deployment)

    Per RESEARCH.md:
    - Use upload-pages-artifact v4 and deploy-pages v4
    - Include .nojekyll to prevent Jekyll filtering (pitfall #5)
    - Set concurrency group to queue deployments (pitfall #7)
  </action>
  <verify>
    Workflow exists: `cat .github/workflows/deploy.yml`
    Has correct permissions block
    Has STORYBOOK_BASE environment variable
    Creates .nojekyll in site-dist
  </verify>
  <done>
    deploy.yml exists with build and deploy jobs
    STORYBOOK_BASE is set to /decentralized-card-games/storybook/
    .nojekyll file is created in compose step
    Permissions include pages: write and id-token: write
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists with correct structure
2. `.storybook/main.ts` has viteFinal with STORYBOOK_BASE support
3. Deploy workflow only triggers on main branch push
4. Deploy workflow has correct permissions (pages: write, id-token: write)
5. Compose step creates site-dist/storybook/ and .nojekyll
6. `npm run typecheck` passes with updated Storybook config
</verification>

<success_criteria>
- Deployment workflow ready to deploy to GitHub Pages on merge to main
- Storybook configured for subdirectory deployment at /storybook/
- .nojekyll included to prevent Jekyll asset filtering
- Workflow structured to accommodate future landing page and games (Phase 8+)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cicd-foundation-deployment-infrastructure/07-02-SUMMARY.md`
</output>
