---
phase: 02-container-components-layouts
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/Hand/Hand.tsx
  - src/components/Hand/Hand.types.ts
  - src/components/Hand/Hand.module.css
  - src/components/Hand/Hand.test.tsx
  - src/components/Hand/index.ts
autonomous: true

must_haves:
  truths:
    - "Hand component renders cards in fan arrangement by default"
    - "Hand supports fan, spread, and stack layout modes"
    - "Hand adapts card spacing based on container width"
    - "Cards animate in/out when added or removed from hand"
    - "Hand supports both controlled and uncontrolled card selection"
    - "Hover effect lifts or highlights individual cards"
    - "Hand exposes selectCard and getSelectedCards via ref"
  artifacts:
    - path: "src/components/Hand/Hand.tsx"
      provides: "Hand container component"
      exports: ["Hand"]
      min_lines: 80
    - path: "src/components/Hand/Hand.types.ts"
      provides: "HandProps, HandRef interfaces"
      exports: ["HandProps", "HandRef"]
    - path: "src/components/Hand/Hand.module.css"
      provides: "Hand container styles with isolation, card slots, hover effects"
      contains: "isolation: isolate"
    - path: "src/components/Hand/Hand.test.tsx"
      provides: "Component tests for Hand"
      min_lines: 80
  key_links:
    - from: "src/components/Hand/Hand.tsx"
      to: "src/utils/layout.ts"
      via: "import layout calculators"
      pattern: "import.*calculate(Fan|Spread|Stack)Layout.*from.*utils"
    - from: "src/components/Hand/Hand.tsx"
      to: "src/hooks/useContainerSize.ts"
      via: "import useContainerSize"
      pattern: "import.*useContainerSize.*from.*hooks"
    - from: "src/components/Hand/Hand.tsx"
      to: "src/components/Card/Card.tsx"
      via: "renders Card components"
      pattern: "<Card"
    - from: "src/components/Hand/Hand.tsx"
      to: "motion/react"
      via: "AnimatePresence for enter/exit animations"
      pattern: "AnimatePresence"
---

<objective>
Build the Hand component -- the most feature-rich container in Phase 2. It renders cards in fan, spread, or stack arrangements using the layout utilities from Plan 01, adapts to container width via useContainerSize, supports controlled/uncontrolled card selection, and animates card enter/exit with Motion's AnimatePresence.

Purpose: The Hand is the primary player-facing container. Poker hands, card game hands, and any player-held card collection uses this component.

Output: Fully tested Hand component with fan/spread/stack layouts, selection, hover effects, and ref API.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-container-components-layouts/02-CONTEXT.md
@.planning/phases/02-container-components-layouts/02-RESEARCH.md
@.planning/phases/02-container-components-layouts/02-01-SUMMARY.md
@src/components/Card/Card.tsx
@src/components/Card/Card.types.ts
@src/components/Card/Card.module.css
@src/types/card.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hand component types and styles</name>
  <files>
    src/components/Hand/Hand.types.ts
    src/components/Hand/Hand.module.css
    src/components/Hand/index.ts
  </files>
  <action>
    **1. Hand types (`src/components/Hand/Hand.types.ts`):**

    Import `CardInput` from `../../types` and `FanPreset` from `../../constants`.

    ```typescript
    export type HandLayout = 'fan' | 'spread' | 'stack';
    export type HoverEffect = 'lift' | 'highlight' | 'none';

    export interface HandProps {
      /** Cards to display. Accepts CardData objects, string notation, or mixed. */
      cards: CardInput[];

      /** Layout arrangement. Default: 'fan'. */
      layout?: HandLayout;

      /** Fan preset (only used when layout='fan'). Default: 'standard'. */
      fanPreset?: FanPreset;

      /** Controlled selection: indices of selected cards. */
      selectedCards?: number[];

      /** Fired when selection changes (controlled mode). */
      onSelectionChange?: (indices: number[]) => void;

      /** Fired when any card is clicked. */
      onCardClick?: (card: CardData, index: number) => void;

      /** Hover effect on individual cards. Default: 'lift'. */
      hoverEffect?: HoverEffect;

      /** Whether all cards are face up. Default: true. */
      faceUp?: boolean;

      /** Additional CSS class for the hand container. */
      className?: string;
    }

    export interface HandRef {
      /** Programmatically toggle selection of a card by index. */
      selectCard: (index: number) => void;
      /** Get indices of currently selected cards. */
      getSelectedCards: () => number[];
    }
    ```

    Also import `CardData` from `../../types` for the onCardClick callback type.

    **2. Hand styles (`src/components/Hand/Hand.module.css`):**

    ```css
    .hand {
      position: relative;
      isolation: isolate;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      width: 100%;
      min-height: 200px;
    }

    .cardSlot {
      position: absolute;
      transform-origin: bottom center;
      cursor: pointer;
      /* Smooth transitions for layout changes */
      transition: filter 0.2s ease;
    }

    .cardSlot--selected {
      filter: brightness(1.1);
    }

    /* Lift hover: translate card upward */
    @media (hover: hover) {
      .hand--hover-lift .cardSlot:hover {
        /* Applied via inline transform to avoid conflicting with position transforms */
        filter: brightness(1.05);
      }
    }

    /* Highlight hover: add glow */
    @media (hover: hover) {
      .hand--hover-highlight .cardSlot:hover {
        filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
      }
    }

    /* Selected card lift */
    .cardSlot--selected {
      /* Selected cards shift up slightly - applied via motion animate y offset */
    }

    /* Empty hand */
    .hand--empty {
      border: 2px dashed rgba(0, 0, 0, 0.15);
      border-radius: 8px;
    }
    ```

    **3. Barrel export (`src/components/Hand/index.ts`):**

    ```typescript
    export { Hand } from './Hand';
    export type { HandProps, HandRef, HandLayout, HoverEffect } from './Hand.types';
    ```
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    Files exist at expected paths.
  </verify>
  <done>
    Hand types define HandProps with layout/selection/hover/event props, HandRef with selectCard/getSelectedCards. CSS module provides isolated stacking context, hover effects gated behind @media(hover:hover), and card slot positioning base.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Hand component with layout integration and AnimatePresence</name>
  <files>
    src/components/Hand/Hand.tsx
    src/components/Hand/Hand.test.tsx
  </files>
  <action>
    **1. Hand component (`src/components/Hand/Hand.tsx`):**

    Follow the Phase 1 pattern: `forwardRef` + `useImperativeHandle`, JSDoc, named export.

    Imports:
    - `forwardRef, useImperativeHandle, useState, useMemo, useCallback` from react
    - `motion, AnimatePresence` from `motion/react`
    - `Card` from `../Card`
    - `useContainerSize, usePrefersReducedMotion` from `../../hooks`
    - `calculateFanLayout, calculateSpreadLayout, calculateStackLayout` from `../../utils`
    - `normalizeCard, formatCard` from `../../types`
    - Types from `./Hand.types`
    - Styles from `./Hand.module.css`

    Implementation details:

    **Container sizing:**
    - Use `useContainerSize()` to get container `ref` and `size`
    - Derive `cardWidth` and `cardHeight` from container width: `cardWidth = Math.max(60, size.width / (cards.length + 4))`, capped at 120px. `cardHeight = cardWidth * 1.4` (poker aspect ratio).

    **Layout calculation (useMemo):**
    - Memoize on `[cards.length, layout, fanPreset, size.width]`
    - Switch on `layout` prop to call the appropriate `calculate*Layout` function
    - Fan: pass `{ preset: fanPreset, cardWidth, cardHeight }`
    - Spread: pass `{ containerWidth: size.width, cardWidth, minOverlap: 30, maxGap: 8 }`
    - Stack: pass default options

    **Card normalization:**
    - `useMemo` to normalize all CardInput[] to CardData[] using `normalizeCard`
    - Filter out nulls (invalid notations)

    **Selection state:**
    - Detect controlled mode: `selectedCards` prop is defined
    - Uncontrolled mode: internal `useState<Set<number>>(new Set())`
    - `effectiveSelected`: controlled ? `new Set(selectedCards)` : internal set

    **useImperativeHandle (HandRef):**
    - `selectCard(index)`: toggle index in selection set. In controlled mode, call `onSelectionChange` with updated array. In uncontrolled mode, update internal state.
    - `getSelectedCards()`: return `Array.from(effectiveSelected)`

    **Card click handler:**
    - `handleCardClick(card, index)`: call `onCardClick?.(card, index)`, toggle selection

    **Render:**
    ```tsx
    const handClasses = [
      styles.hand,
      hoverEffect === 'lift' ? styles['hand--hover-lift'] : undefined,
      hoverEffect === 'highlight' ? styles['hand--hover-highlight'] : undefined,
      normalizedCards.length === 0 ? styles['hand--empty'] : undefined,
      className,
    ].filter(Boolean).join(' ');

    return (
      <div ref={containerRef} className={handClasses} data-testid="hand">
        <AnimatePresence mode="popLayout">
          {normalizedCards.map((card, i) => {
            const layout = layouts[i];
            const key = formatCard(card);
            const isSelected = effectiveSelected.has(i);
            const selectedYOffset = isSelected ? -15 : 0;

            return (
              <motion.div
                key={key}
                className={[
                  styles.cardSlot,
                  isSelected ? styles['cardSlot--selected'] : undefined,
                ].filter(Boolean).join(' ')}
                layout
                initial={{ opacity: 0, scale: 0.8, y: 20 }}
                animate={{
                  opacity: 1,
                  scale: layout?.scale ?? 1,
                  x: layout?.x ?? 0,
                  y: (layout?.y ?? 0) + selectedYOffset,
                  rotate: layout?.rotation ?? 0,
                }}
                exit={{ opacity: 0, scale: 0.8 }}
                transition={prefersReducedMotion
                  ? { duration: 0 }
                  : { type: 'spring', stiffness: 300, damping: 25 }
                }
                style={{ zIndex: layout?.zIndex ?? 0 }}
                onClick={() => handleCardClick(card, i)}
              >
                <Card
                  card={card}
                  isFaceUp={faceUp ?? true}
                />
              </motion.div>
            );
          })}
        </AnimatePresence>
      </div>
    );
    ```

    Important: Use `formatCard(card)` as the AnimatePresence key (not array index) per RESEARCH.md pitfall 4.

    Set `Hand.displayName = 'Hand'`.

    **2. Hand tests (`src/components/Hand/Hand.test.tsx`):**

    Mock ResizeObserver (same pattern as useContainerSize tests). Mock Motion's AnimatePresence to render children directly (avoid animation timing issues in tests).

    Tests:
    - Renders correct number of Card components for given cards array
    - Accepts string notation cards ('sA', 'h7') and CardData objects
    - Applies 'fan' layout by default (data-testid="hand" present)
    - Fires onCardClick with card data and index when a card slot is clicked
    - In uncontrolled mode, clicking a card toggles selection (cardSlot--selected class)
    - In controlled mode, renders selectedCards indices as selected
    - Ref API: selectCard toggles selection, getSelectedCards returns indices
    - Renders empty state class when cards array is empty
    - Applies hover-lift class by default, hover-highlight when specified
    - Accepts className prop and merges with hand classes
    - Handles mixed array of strings and CardData objects
    - Filters out invalid card notations gracefully (no crash)
  </action>
  <verify>
    `npm test -- src/components/Hand/Hand.test.tsx` passes.
    `npx tsc --noEmit` passes.
  </verify>
  <done>
    Hand component renders cards using layout utilities, supports fan/spread/stack modes, controlled/uncontrolled selection, hover effects, AnimatePresence for enter/exit, and ref API with selectCard/getSelectedCards. Tests cover rendering, interaction, selection, and edge cases.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- types resolve for Hand, its props, ref, and all layout utility imports
2. `npm test -- src/components/Hand` -- all Hand tests pass
3. `npm test` -- full suite passes (no regressions)
</verification>

<success_criteria>
- Hand component renders N cards in fan layout by default
- Switching layout prop to 'spread' or 'stack' changes card arrangement
- Container width affects card sizing and spacing (via useContainerSize)
- Cards animate in (fade+scale) and out (fade+scale) via AnimatePresence
- Controlled selection: selectedCards prop highlights specified indices
- Uncontrolled selection: clicking toggles selection visually
- Ref API: selectCard(index) and getSelectedCards() work
- Hover effect (lift/highlight/none) respects @media(hover:hover)
- Empty hand shows dashed border placeholder
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-container-components-layouts/02-02-SUMMARY.md`
</output>
