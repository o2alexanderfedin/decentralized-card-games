---
phase: 02-container-components-layouts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/containers.ts
  - src/types/index.ts
  - src/constants/layouts.ts
  - src/constants/index.ts
  - src/utils/layout.ts
  - src/utils/layout.test.ts
  - src/utils/index.ts
  - src/hooks/useContainerSize.ts
  - src/hooks/useContainerSize.test.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Layout utilities calculate correct positions for fan, spread, and stack arrangements"
    - "Fan layout distributes cards along an arc with configurable angle presets"
    - "Spread layout adapts spacing based on container width and card count"
    - "Stack layout offsets cards diagonally with slight rotation"
    - "useContainerSize hook reports container dimensions via ResizeObserver"
    - "Edge cases (0, 1, 2, 10+ cards) produce valid layouts without NaN or Infinity"
  artifacts:
    - path: "src/types/containers.ts"
      provides: "CardInput type, CardLayout interface, normalizeCard helper"
      exports: ["CardInput", "CardLayout", "normalizeCard"]
    - path: "src/constants/layouts.ts"
      provides: "Fan presets, layout default values"
      exports: ["FAN_PRESETS", "LAYOUT_DEFAULTS"]
    - path: "src/utils/layout.ts"
      provides: "Pure layout calculation functions"
      exports: ["calculateFanLayout", "calculateSpreadLayout", "calculateStackLayout"]
    - path: "src/utils/layout.test.ts"
      provides: "Comprehensive tests for all layout functions"
      min_lines: 100
    - path: "src/hooks/useContainerSize.ts"
      provides: "ResizeObserver-based container measurement hook"
      exports: ["useContainerSize"]
  key_links:
    - from: "src/utils/layout.ts"
      to: "src/types/containers.ts"
      via: "import CardLayout type"
      pattern: "import.*CardLayout.*from.*types"
    - from: "src/utils/layout.ts"
      to: "src/constants/layouts.ts"
      via: "import FAN_PRESETS"
      pattern: "import.*FAN_PRESETS.*from.*constants"
    - from: "src/hooks/index.ts"
      to: "src/hooks/useContainerSize.ts"
      via: "barrel export"
      pattern: "export.*useContainerSize"
---

<objective>
Create the layout foundation for Phase 2 container components: pure layout calculation functions (fan, spread, stack), shared container types, layout preset constants, and a useContainerSize hook.

Purpose: All container components (Hand, Deck, CardStack) depend on these utilities for positioning cards. Building them first as pure functions enables thorough testing and parallel component development in subsequent plans.

Output: Tested layout utilities, container types, layout constants, and useContainerSize hook -- all exported through barrel files.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-container-components-layouts/02-CONTEXT.md
@.planning/phases/02-container-components-layouts/02-RESEARCH.md
@src/types/card.ts
@src/types/index.ts
@src/constants/index.ts
@src/hooks/index.ts
@src/hooks/usePrefersReducedMotion.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create container types, layout constants, and layout utility functions</name>
  <files>
    src/types/containers.ts
    src/types/index.ts
    src/constants/layouts.ts
    src/constants/index.ts
    src/utils/layout.ts
    src/utils/index.ts
  </files>
  <action>
    **1. Container types (`src/types/containers.ts`):**

    Create shared types for container components:
    - `CardInput = string | CardData` -- containers accept card objects or string notation
    - `CardLayout` interface with fields: `x: number`, `y: number`, `rotation: number`, `zIndex: number`, `scale: number`
    - `normalizeCard(input: CardInput): CardData | null` helper that delegates to `parseCard` for strings, passes through `CardData` objects
    - Import `CardData` and `parseCard` from `./card`

    **2. Update types barrel (`src/types/index.ts`):**

    Add `export * from './containers'` to existing barrel. Keep existing card exports.

    **3. Layout constants (`src/constants/layouts.ts`):**

    Create layout preset constants:
    ```typescript
    export type FanPreset = 'subtle' | 'standard' | 'dramatic';

    export const FAN_PRESETS: Record<FanPreset, number> = {
      subtle: 35,     // total arc angle in degrees
      standard: 60,
      dramatic: 90,
    };

    export const LAYOUT_DEFAULTS = {
      fan: {
        preset: 'standard' as FanPreset,
        radius: 3,  // in card-height multiples
      },
      spread: {
        minOverlap: 30,  // px - minimum visible portion of each card
        maxGap: 8,       // px - maximum gap between cards
      },
      stack: {
        offsetX: 2,      // px per card
        offsetY: 2,      // px per card
        maxRotation: 3,  // degrees total spread
      },
    } as const;
    ```

    **4. Update constants barrel (`src/constants/index.ts`):**

    Add exports for `FAN_PRESETS`, `LAYOUT_DEFAULTS`, and `type FanPreset` from `./layouts`.

    **5. Layout calculation functions (`src/utils/layout.ts`):**

    Create three pure functions. All return `CardLayout[]`. Import `CardLayout` from types, `FAN_PRESETS` and `LAYOUT_DEFAULTS` from constants.

    **`calculateFanLayout(count, options)`:**
    - Options: `{ preset?: FanPreset, maxAngle?: number, radius?: number, cardWidth: number, cardHeight: number }`
    - `maxAngle` overrides preset if provided; default from `FAN_PRESETS[preset ?? 'standard']`
    - `radius` defaults to `LAYOUT_DEFAULTS.fan.radius * cardHeight`
    - Edge cases: count=0 returns []; count=1 returns single centered card (x:0, y:0, rotation:0)
    - For count<=3, scale effective angle: `maxAngle * (count / 5)` to avoid extreme spread
    - For count>3, use: `Math.min(maxAngle, maxAngle * Math.sqrt(count / 7))` for gentle scaling
    - Each card positioned on arc: `x = radius * sin(angle)`, `y = radius * (1 - cos(angle))`
    - Angles distributed evenly from `-effectiveAngle/2` to `+effectiveAngle/2`
    - zIndex sequential from 1

    **`calculateSpreadLayout(count, options)`:**
    - Options: `{ containerWidth: number, cardWidth: number, minOverlap?: number, maxGap?: number }`
    - Defaults from `LAYOUT_DEFAULTS.spread`
    - If all cards fit with maxGap, use maxGap spacing
    - If not, compress spacing. Clamp minimum spacing to `minOverlap`
    - Center the spread: `startX = -(totalWidth - cardWidth) / 2`
    - All cards at y=0, rotation=0, scale=1
    - Edge cases: count=0 returns []; count=1 returns centered at x=0

    **`calculateStackLayout(count, options?)`:**
    - Options: `{ offsetX?: number, offsetY?: number, maxRotation?: number }` -- all optional with defaults from `LAYOUT_DEFAULTS.stack`
    - Each card offset by `(i * offsetX, i * offsetY)`
    - Rotation distributed from `-maxRotation/2` to `+maxRotation/2` for count>1; 0 for count<=1
    - count=0 returns []

    **6. Utils barrel (`src/utils/index.ts`):**

    Create barrel: `export * from './layout'`
  </action>
  <verify>
    `npx tsc --noEmit` passes (type checking).
    All new exports visible from `src/utils/index.ts`, `src/types/index.ts`, `src/constants/index.ts`.
  </verify>
  <done>
    Three layout calculation functions exist as pure functions. CardLayout type, CardInput type, normalizeCard helper, FanPreset type, FAN_PRESETS and LAYOUT_DEFAULTS constants all exported through barrels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useContainerSize hook</name>
  <files>
    src/hooks/useContainerSize.ts
    src/hooks/useContainerSize.test.ts
    src/hooks/index.ts
  </files>
  <action>
    **1. useContainerSize hook (`src/hooks/useContainerSize.ts`):**

    Follow the pattern from Phase 1 hooks (standalone file, JSDoc, typed return).

    ```typescript
    interface ContainerSize {
      width: number;
      height: number;
    }

    export function useContainerSize<T extends HTMLElement = HTMLDivElement>(): {
      ref: RefObject<T | null>;
      size: ContainerSize;
    }
    ```

    Implementation:
    - Create `ref` via `useRef<T>(null)`
    - State: `useState<ContainerSize>({ width: 0, height: 0 })`
    - `useEffect` that creates `ResizeObserver`, observes `ref.current`, returns cleanup `observer.disconnect()`
    - On resize: read `entry.contentRect`, round width/height with `Math.round()`, only update state if values changed (compare with prev to avoid infinite loops per RESEARCH.md pitfall 3)
    - Export `ContainerSize` type

    **2. Hook tests (`src/hooks/useContainerSize.test.ts`):**

    Test with a mock ResizeObserver:
    - Returns ref object and initial size {width: 0, height: 0}
    - After ResizeObserver fires, size updates
    - Rounds dimensions to integers
    - Does not re-render when size unchanged (same rounded values)
    - Disconnects observer on unmount

    Mock ResizeObserver in test setup or inline:
    ```typescript
    let resizeCallback: ResizeObserverCallback;
    const mockObserve = vi.fn();
    const mockDisconnect = vi.fn();

    beforeEach(() => {
      vi.stubGlobal('ResizeObserver', class {
        constructor(cb: ResizeObserverCallback) { resizeCallback = cb; }
        observe = mockObserve;
        disconnect = mockDisconnect;
        unobserve = vi.fn();
      });
    });
    ```

    **3. Update hooks barrel (`src/hooks/index.ts`):**

    Add:
    ```typescript
    export { useContainerSize } from './useContainerSize';
    export type { ContainerSize } from './useContainerSize';
    ```

    Keep existing useCardFlip and usePrefersReducedMotion exports.
  </action>
  <verify>
    `npm test -- src/hooks/useContainerSize.test.ts` passes.
    `npx tsc --noEmit` passes.
  </verify>
  <done>
    useContainerSize hook exists, is tested, and is exported from hooks barrel. Uses ResizeObserver with rounding to prevent infinite loops.
  </done>
</task>

<task type="auto">
  <name>Task 3: Write comprehensive layout utility tests</name>
  <files>
    src/utils/layout.test.ts
  </files>
  <action>
    Write thorough tests for all three layout functions. These are pure functions, so tests are straightforward input/output assertions. Use `describe` blocks per function.

    **calculateFanLayout tests:**
    - Returns empty array for count=0
    - Returns single centered card for count=1 (x:0, y:0, rotation:0, zIndex:1, scale:1)
    - Returns 2 cards with reduced angle spread (scaled by count/5)
    - Returns 5 cards with angles distributed symmetrically around 0
    - Middle card of odd count is at rotation ~0
    - First card has negative rotation, last has positive
    - All zIndex values are sequential (1, 2, 3...)
    - Respects preset: 'subtle' produces smaller angles than 'dramatic'
    - Custom maxAngle overrides preset
    - Y values form an arc (middle cards have smallest y, edge cards have larger y)
    - No NaN or Infinity in any output

    **calculateSpreadLayout tests:**
    - Returns empty array for count=0
    - Returns single centered card for count=1 (x:0)
    - Cards are evenly spaced when container is wide enough
    - Cards overlap when container is too narrow
    - Spacing never goes below minOverlap
    - Spread is centered (first card x is negative, last is positive, symmetric)
    - All rotations are 0, all y values are 0
    - With 2 cards, they are equally spaced from center

    **calculateStackLayout tests:**
    - Returns empty array for count=0
    - Returns single card at (0,0) with rotation 0 for count=1
    - Cards offset incrementally by offsetX and offsetY
    - Rotation distributed from -maxRotation/2 to +maxRotation/2
    - Default options used when none provided
    - Custom offsets respected

    Use `toBeCloseTo` for floating point comparisons on rotation angles and arc positions.
  </action>
  <verify>
    `npm test -- src/utils/layout.test.ts` passes with all tests green.
    No test marked as `.skip` or `.todo`.
  </verify>
  <done>
    All three layout calculation functions have comprehensive test coverage including edge cases (0, 1, 2 cards), preset variations, and numerical correctness.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all types resolve correctly
2. `npm test -- src/utils/layout.test.ts` -- all layout tests pass
3. `npm test -- src/hooks/useContainerSize.test.ts` -- hook tests pass
4. `npm test` -- full suite still passes (no regressions from Phase 1)
</verification>

<success_criteria>
- Three layout functions (fan, spread, stack) calculate correct positions as pure functions
- CardLayout, CardInput, normalizeCard types/helpers exported from types barrel
- FAN_PRESETS and LAYOUT_DEFAULTS constants exported from constants barrel
- useContainerSize hook works with ResizeObserver, exported from hooks barrel
- All layout edge cases (0, 1, 2, 10+ cards) produce valid output without NaN/Infinity
- Full test suite passes (Phase 1 + new tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-container-components-layouts/02-01-SUMMARY.md`
</output>
